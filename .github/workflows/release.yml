name: Release

on:
  push:
    tags: ["v*.*.*"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15-intel
            target: MacosX64
            binary_name: kmpli-macos-x64
            binary_path: composeApp/build/bin/macosX64/releaseExecutable/kmpli.kexe

          - os: macos-latest
            target: MacosArm64
            binary_name: kmpli-macos-arm64
            binary_path: composeApp/build/bin/macosArm64/releaseExecutable/kmpli.kexe

          - os: ubuntu-latest
            target: LinuxX64
            binary_name: kmpli-linux-x64
            binary_path: composeApp/build/bin/linuxX64/releaseExecutable/kmpli.kexe

          - os: windows-latest
            target: MingwX64
            binary_name: kmpli-windows-x64.exe
            binary_path: composeApp/build/bin/mingwX64/releaseExecutable/kmpli.exe

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK-17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Kotlin/Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Mac Dependencies
        if: startsWith(matrix.os, 'macos')
        run: brew install openssl curl

      - name: Linux Dependencies
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev

      - name: Windows Dependencies
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          choco install -y curl openssl.light
          try { choco install -y winlibs } catch { Write-Host "winlibs not found, continuing..." }

      - name: Build
        shell: bash
        run: |
          chmod +x gradlew
          ./gradlew compileKotlin${{ matrix.target }} linkReleaseExecutable${{ matrix.target }}

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary_name }}
          path: ${{ matrix.binary_path }}
          retention-days: 1

  create-release:
    name: Create Release
    needs: build-binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download All Binaries
        uses: actions/download-artifact@v4
        with:
          path: release-binaries

      - name: Prepare Release Assets
        run: |
          mkdir -p release

          # Copy and rename binaries
          cp release-binaries/kmpli-macos-x64/kmpli.kexe release/kmpli-macos-x64
          cp release-binaries/kmpli-macos-arm64/kmpli.kexe release/kmpli-macos-arm64
          cp release-binaries/kmpli-linux-x64/kmpli.kexe release/kmpli-linux-x64
          cp release-binaries/kmpli-windows-x64.exe/kmpli.exe release/kmpli-windows-x64.exe

          chmod +x release/kmpli-*

          # Compute SHA256 hashes
          echo "SHA_MACOS_X64=$(sha256sum release/kmpli-macos-x64 | cut -d ' ' -f 1)" >> $GITHUB_ENV
          echo "SHA_MACOS_ARM64=$(sha256sum release/kmpli-macos-arm64 | cut -d ' ' -f 1)" >> $GITHUB_ENV
          echo "SHA_LINUX_X64=$(sha256sum release/kmpli-linux-x64 | cut -d ' ' -f 1)" >> $GITHUB_ENV
          echo "SHA_WINDOWS_X64=$(sha256sum release/kmpli-windows-x64.exe | cut -d ' ' -f 1)" >> $GITHUB_ENV

          # Create source archive
          VERSION=${GITHUB_REF/refs\/tags\//}
          echo "RELEASE_NAME=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_ENV

          zip -r "release/kmpli-source.zip" . \
            -x ".DS_Store" \
               ".git/*" \
               ".github/*" \
               ".gradle/*" \
               ".idea/*" \
               ".kotlin/*" \
               "build/*" \
               "composeApp/build/*" \
               "release/*" \
               "release-binaries/*"

      - name: Generate Changelog
        run: |
          # Get all commits from the previous tag to this tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${GITHUB_REF}^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            RELEASE_NOTES=$(git log ${PREV_TAG}..${GITHUB_REF} --pretty=format:"- %s")
          else
            RELEASE_NOTES="Initial release"
          fi

          # Add download instructions
          cat >> release-notes.md << EOF
          ## Installation

          ### Quick Install (Recommended)

          **macOS/Linux:**
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/chornge/kmpli/main/install.sh | bash
          \`\`\`

          **Windows (PowerShell):**
          \`\`\`powershell
          irm https://raw.githubusercontent.com/chornge/kmpli/main/install.ps1 | iex
          \`\`\`

          The installer will set up the launcher script. The appropriate binary for your platform will be automatically downloaded on first run.

          ### Package Managers

          **Homebrew (macOS/Linux):**
          \`\`\`bash
          brew tap chornge/kmpli && brew install kmpli
          \`\`\`

          **Scoop (Windows):**
          \`\`\`powershell
          scoop bucket add kmpli https://github.com/chornge/kmpli && scoop install kmpli
          \`\`\`

          ### Manual Download

          Download the appropriate binary for your platform:
          - **macOS (Apple Silicon)**: \`kmpli-macos-arm64\`
          - **macOS (Intel)**: \`kmpli-macos-x64\`
          - **Linux (x64)**: \`kmpli-linux-x64\`
          - **Windows (x64)**: \`kmpli-windows-x64.exe\`

          Make it executable and move to your PATH.

          ## Changes

          $RELEASE_NOTES
          EOF

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          cat release-notes.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: ${{ env.RELEASE_NAME }}
          body: ${{ env.RELEASE_NOTES }}
          files: |
            release/kmpli-macos-x64
            release/kmpli-macos-arm64
            release/kmpli-linux-x64
            release/kmpli-windows-x64.exe
            release/kmpli-source.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print Package Manifest Info
        run: |
          echo "=========================================="
          echo "Package Manifest Update Info"
          echo "=========================================="
          echo ""
          echo "Version: ${VERSION_NUMBER}"
          echo "Release: ${RELEASE_NAME}"
          echo ""
          echo "SHA256 Checksums:"
          echo "  macOS x64:   ${SHA_MACOS_X64}"
          echo "  macOS arm64: ${SHA_MACOS_ARM64}"
          echo "  Linux x64:   ${SHA_LINUX_X64}"
          echo "  Windows x64: ${SHA_WINDOWS_X64}"
          echo ""
          echo "To update Homebrew/Scoop manifests, update:"
          echo "  - Formula/kmpli.rb"
          echo "  - bucket/kmpli.json"
          echo "with the version and checksums above."
          echo "=========================================="
