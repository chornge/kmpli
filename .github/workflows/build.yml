name: Build

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS (Intel)
          - os: macos-13
            arch: x64
            target: MacosX64
          # macOS (Apple)
          - os: macos-14
            arch: arm64
            target: MacosArm64
          # Linux (x64)
          - os: ubuntu-24.04
            arch: x64
            target: LinuxX64
          # Linux (arm64)
          - os: ubuntu-24.04
            arch: arm64
            target: LinuxArm64
          # Windows (x64)
          - os: windows-latest
            arch: x64
            target: MingwX64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: JDK-17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build
        shell: bash
        run: |
          chmod +x gradlew
          ./gradlew build

      - name: Test
        shell: bash
        run: |
          ./gradlew allTests

      - name: Build binaries
        shell: bash
        run: |
          ./gradlew linkReleaseExecutable${{ matrix.target }}

#      - name: Copy binaries
#        shell: bash
#        run: |
#          BIN_DIR=build/bin/${{ matrix.target.toLower() }}/releaseExecutable
#          mkdir -p build/dist
#          cp $BIN_DIR/* build/dist/
#          ls -lh build/dist/
#
#      - name: Upload artifacts
#        uses: actions/upload-artifact@v4
#        with:
#          name: kmpli-${{ matrix.target }}
#          path: build/dist/
